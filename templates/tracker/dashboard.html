{% extends 'tracker/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>–î–∞—à–±–æ—Ä–¥ (—Å–µ–≥–æ–¥–Ω—è)</h2>
  <a class="btn btn-success" href="{% url 'entry_add' %}">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</a>
</div>

<div class="card mb-4">
  <div class="card-body" style="height:220px">
    <canvas id="chart"></canvas>
    <script>
      const data = {{ data|safe }};
      const labels = ['–£—á—ë–±–∞','–û—Ç–¥—ã—Ö','–°–æ–Ω','–î—Ä—É–≥–æ–µ'];
      const values = [data.study||0, data.rest||0, data.sleep||0, data.other||0];
      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{ data: values, hoverOffset: 4 }]
        },
        options: {responsive:true, maintainAspectRatio:false}
      });
    </script>
  </div>
</div>

<div class="row">
  <div class="col-md-4">
    <div class="card p-3">
      <h5>–ò—Ç–æ–≥–æ (–º–∏–Ω)</h5>
      <ul class="list-unstyled">
        <li>–£—á—ë–±–∞: <strong>{{ data.study }}</strong></li>
        <li>–û—Ç–¥—ã—Ö: <strong>{{ data.rest }}</strong></li>
        <li>–°–æ–Ω: <strong>{{ data.sleep }}</strong></li>
        <li>–î—Ä—É–≥–æ–µ: <strong>{{ data.other }}</strong></li>
      </ul>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card mt-4 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="updateAdvice()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–≤–µ—Ç—ã</button>
      </div>
      <div class="card-body">
        <ul id="advice-list">
          {% for item in advice %}
            <li>{{ item }}</li>
          {% empty %}
            <li>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–≤–æ–∏ —Å–æ–≤–µ—Ç—ã.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
async function updateAdvice() {
  const response = await fetch("{% url 'get_advice' %}");
  const data = await response.json();
  const adviceList = document.getElementById('advice-list');
  adviceList.innerHTML = data.advice.map(a => `<li>${a}</li>`).join('');
}

// –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–≤–µ—Ç–æ–≤ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
setInterval(updateAdvice, 60000);

// –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–≤–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
updateAdvice();
</script>
{% endblock %}
